<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Python中如何在一个函数中加入多个装饰器? | </title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../12/README.html" />
    
    
    <link rel="prev" href="../123/README.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="3" data-basepath=".." data-revision="1415190338739">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Stackoverflow about Python
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="chapter/README.html">
            
                
                    <a href="../chapter/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Python中关键字yield有什么作用?
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="123/README.html">
            
                
                    <a href="../123/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Python中的元类(metaclass)是什么?
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="3" data-path="pass/README.html">
            
                
                    <a href="../pass/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Python中如何在一个函数中加入多个装饰器?
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="12/README.html">
            
                
                    <a href="../12/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         用Python如何检测一个文件是否存在?
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="1231/README.html">
            
                
                    <a href="../1231/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         在Python中有三元运算符吗?
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="qwe/README.html">
            
                
                    <a href="../qwe/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         在Python中调用外部命令?
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" ></a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_3140">
                    
                        <table>
<thead>
<tr>
<th style="text-align:center">rank</th>
<th style="text-align:center">▲</th>
<th style="text-align:center">✰</th>
<th style="text-align:center">vote</th>
<th style="text-align:center">url</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1346</td>
<td style="text-align:center">1485</td>
<td style="text-align:center">2648</td>
<td style="text-align:center"><a href="http://stackoverflow.com/questions/739654/how-can-i-make-a-chain-of-function-decorators-in-python" target="_blank">url</a></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="python">Python中如何在一个函数中加入多个装饰器?</h2>
<p>怎么做才能让一个函数同时用两个装饰器,像下面这样:</p>
<pre><code class="lang-python"><span class="hljs-decorator">@makebold</span>
<span class="hljs-decorator">@makeitalic</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span><span class="hljs-params">()</span>:</span>
   <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>
</code></pre>
<p>我希望得到</p>
<pre><code class="lang-python">&lt;b&gt;&lt;i&gt;Hello&lt;/i&gt;&lt;/b&gt;
</code></pre>
<p>我只是想知道装饰器怎么工作的!</p>
<hr>
<p>去看看<a href="https://docs.python.org/2/reference/compound_stmts.html#function" target="_blank">文档</a>,答在下面:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makebold</span><span class="hljs-params">(fn)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;b&gt;"</span> + fn() + <span class="hljs-string">"&lt;/b&gt;"</span>
    <span class="hljs-keyword">return</span> wrapped

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makeitalic</span><span class="hljs-params">(fn)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;i&gt;"</span> + fn() + <span class="hljs-string">"&lt;/i&gt;"</span>
    <span class="hljs-keyword">return</span> wrapped

<span class="hljs-decorator">@makebold</span>
<span class="hljs-decorator">@makeitalic</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"hello world"</span>

<span class="hljs-keyword">print</span> hello() <span class="hljs-comment">## returns &lt;b&gt;&lt;i&gt;hello world&lt;/i&gt;&lt;/b&gt;</span>
</code></pre>
<h2 id="answer2">Answer:2</h2>
<p>如果你不想看详细的解释的话请看上面那个答案.</p>
<h3 id="">装饰器基础</h3>
<h4 id="python">Python的函数都是对象</h4>
<p>要了解装饰器,你必须了解Python中的函数都是对象.这个意义非常重要.让我们看看一个简单例子:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shout</span><span class="hljs-params">(word=<span class="hljs-string">"yes"</span>)</span>:</span>
    <span class="hljs-keyword">return</span> word.capitalize()+<span class="hljs-string">"!"</span>

<span class="hljs-keyword">print</span> shout()
<span class="hljs-comment"># 输出 : 'Yes!'</span>

<span class="hljs-comment"># 作为一个对象,你可以把它赋值给任何变量</span>

scream = shout

<span class="hljs-comment"># 注意啦我们没有加括号,我们并不是调用这个函数,我们只是把函数"shout"放在了变量"scream"里.</span>
<span class="hljs-comment"># 也就是说我们可以通过"scream"调用"shout":</span>

<span class="hljs-keyword">print</span> scream()
<span class="hljs-comment"># 输出 : 'Yes!'</span>

<span class="hljs-comment"># 你可以删除旧名"shout",而且"scream"依然指向函数</span>

<span class="hljs-keyword">del</span> shout
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">print</span> shout()
<span class="hljs-keyword">except</span> NameError, e:
    <span class="hljs-keyword">print</span> e
    <span class="hljs-comment">#输出: "name 'shout' is not defined"</span>

<span class="hljs-keyword">print</span> scream()
<span class="hljs-comment"># 输出: 'Yes!'</span>
</code></pre>
<p>好了,先记住上面的,一会还会用到.</p>
<p>Python函数另一个有趣的特性就是你可以在一个函数里定义另一个函数!</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">talk</span><span class="hljs-params">()</span>:</span>

    <span class="hljs-comment"># 你可以在"talk"里定义另一个函数 ...</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">whisper</span><span class="hljs-params">(word=<span class="hljs-string">"yes"</span>)</span>:</span>
        <span class="hljs-keyword">return</span> word.lower()+<span class="hljs-string">"..."</span>

    <span class="hljs-comment"># 让我们用用它!</span>

    <span class="hljs-keyword">print</span> whisper()

<span class="hljs-comment"># 每次调用"talk"时都会定义一次"whisper",然后"talk"会调用"whisper"</span>
talk()
<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># "yes..."</span>

<span class="hljs-comment"># 但是在"talk"意外"whisper"是不存在的:</span>

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">print</span> whisper()
<span class="hljs-keyword">except</span> NameError, e:
    <span class="hljs-keyword">print</span> e
    <span class="hljs-comment">#输出 : "name 'whisper' is not defined"*</span>
</code></pre>
<h3 id="">函数引用</h3>
<p>好,终于到了有趣的地方了...</p>
<p>已经知道函数就是对象.因此,对象:</p>
<ul>
<li>可以赋值给一个变量</li>
<li>可以在其他函数里定义</li>
</ul>
<p>这就意味着函数可以返回另一个函数.来看看!☺</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getTalk</span><span class="hljs-params">(kind=<span class="hljs-string">"shout"</span>)</span>:</span>

    <span class="hljs-comment"># 在函数里定义一个函数</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shout</span><span class="hljs-params">(word=<span class="hljs-string">"yes"</span>)</span>:</span>
        <span class="hljs-keyword">return</span> word.capitalize()+<span class="hljs-string">"!"</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">whisper</span><span class="hljs-params">(word=<span class="hljs-string">"yes"</span>)</span> :</span>
        <span class="hljs-keyword">return</span> word.lower()+<span class="hljs-string">"..."</span>;

    <span class="hljs-comment"># 返回一个函数</span>
    <span class="hljs-keyword">if</span> kind == <span class="hljs-string">"shout"</span>:
        <span class="hljs-comment"># 这里不用"()",我们不是要调用函数</span>
        <span class="hljs-comment"># 只是返回函数对象</span>
        <span class="hljs-keyword">return</span> shout
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> whisper

<span class="hljs-comment"># 怎么用这个特性呢?</span>

<span class="hljs-comment"># 把函数赋值给变量</span>
talk = getTalk()

<span class="hljs-comment"># 可以看到"talk"是一个函数对象</span>
<span class="hljs-keyword">print</span> talk
<span class="hljs-comment"># 输出 : &lt;function shout at 0xb7ea817c&gt;</span>

<span class="hljs-comment"># 函数返回的是对象:</span>
<span class="hljs-keyword">print</span> talk()
<span class="hljs-comment"># 输出 : Yes!</span>

<span class="hljs-comment"># 不嫌麻烦你也可以这么用</span>
<span class="hljs-keyword">print</span> getTalk(<span class="hljs-string">"whisper"</span>)()
<span class="hljs-comment"># 输出 : yes...</span>
</code></pre>
<p>既然可以<code>return</code>一个函数, 你也可以在把函数作为参数传递:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doSomethingBefore</span><span class="hljs-params">(func)</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I do something before then I call the function you gave me"</span>
    <span class="hljs-keyword">print</span> func()

doSomethingBefore(scream)
<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment">#I do something before then I call the function you gave me</span>
<span class="hljs-comment">#Yes!</span>
</code></pre>
<p>学习装饰器的基本知识都在上面了.装饰器就是&quot;wrappers&quot;,它可以让你在你装饰函数之前或之后执行程序,而不用修改函数本身.</p>
<h4 id="">自己动手实现装饰器</h4>
<p>怎么样自己做呢:</p>
<pre><code class="lang-python"><span class="hljs-comment"># 装饰器就是把其他函数作为参数的函数</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_shiny_new_decorator</span><span class="hljs-params">(a_function_to_decorate)</span>:</span>

    <span class="hljs-comment"># 在函数里面,装饰器在运行中定义函数: 包装.</span>
    <span class="hljs-comment"># 这个函数将被包装在原始函数的外面,所以可以在原始函数之前和之后执行其他代码..</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">the_wrapper_around_the_original_function</span><span class="hljs-params">()</span>:</span>

        <span class="hljs-comment"># 把要在原始函数被调用前的代码放在这里</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Before the function runs"</span>

        <span class="hljs-comment"># 调用原始函数(用括号)</span>
        a_function_to_decorate()

        <span class="hljs-comment"># 把要在原始函数调用后的代码放在这里</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"After the function runs"</span>

    <span class="hljs-comment"># 在这里"a_function_to_decorate" 函数永远不会被执行</span>
    <span class="hljs-comment"># 在这里返回刚才包装过的函数</span>
    <span class="hljs-comment"># 在包装函数里包含要在原始函数前后执行的代码.</span>
    <span class="hljs-keyword">return</span> the_wrapper_around_the_original_function

<span class="hljs-comment"># 加入你建了个函数,不想修改了</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a_stand_alone_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I am a stand alone function, don't you dare modify me"</span>

a_stand_alone_function()
<span class="hljs-comment">#输出: I am a stand alone function, don't you dare modify me</span>

<span class="hljs-comment"># 现在,你可以装饰它来增加它的功能</span>
<span class="hljs-comment"># 把它传递给装饰器,它就会返回一个被包装过的函数.</span>

a_stand_alone_function_decorated = my_shiny_new_decorator(a_stand_alone_function)
a_stand_alone_function_decorated()
<span class="hljs-comment">#输出s:</span>
<span class="hljs-comment">#Before the function runs</span>
<span class="hljs-comment">#I am a stand alone function, don't you dare modify me</span>
<span class="hljs-comment">#After the function runs</span>
</code></pre>
<p>现在,你或许每次都想用<code>a_stand_alone_function_decorated</code>代替<code>a_stand_alone_function</code>,很简单,只需要用<code>my_shiny_new_decorator</code>返回的函数重写<code>a_stand_alone_function</code>:</p>
<pre><code class="lang-python">a_stand_alone_function = my_shiny_new_decorator(a_stand_alone_function)
a_stand_alone_function()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#Before the function runs</span>
<span class="hljs-comment">#I am a stand alone function, don't you dare modify me</span>
<span class="hljs-comment">#After the function runs</span>

<span class="hljs-comment"># 想到了吗,这就是装饰器干的事!</span>
</code></pre>
<h4 id="">让我们看看装饰器的真实面纱</h4>
<p>用上一个例子,看看装饰器的语法:</p>
<pre><code class="lang-python"><span class="hljs-decorator">@my_shiny_new_decorator</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">another_stand_alone_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Leave me alone"</span>

another_stand_alone_function()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#Before the function runs</span>
<span class="hljs-comment">#Leave me alone</span>
<span class="hljs-comment">#After the function runs</span>
</code></pre>
<p>就这么简单.<code>@decorator</code>就是下面的简写:</p>
<pre><code class="lang-python">another_stand_alone_function = my_shiny_new_decorator(another_stand_alone_function)
</code></pre>
<p>装饰器就是<a href="http://en.wikipedia.org/wiki/Decorator_pattern" target="_blank"> decorator design pattern</a>的pythonic的变种.在Python中有许多经典的设计模式来满足开发者.</p>
<p>当然,你也可以自己写装饰器:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bread</span><span class="hljs-params">(func)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"&lt;/''''''\&gt;"</span>
        func()
        <span class="hljs-keyword">print</span> <span class="hljs-string">"&lt;\______/&gt;"</span>
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ingredients</span><span class="hljs-params">(func)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"#tomatoes#"</span>
        func()
        <span class="hljs-keyword">print</span> <span class="hljs-string">"~salad~"</span>
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sandwich</span><span class="hljs-params">(food=<span class="hljs-string">"--ham--"</span>)</span>:</span>
    <span class="hljs-keyword">print</span> food

sandwich()
<span class="hljs-comment">#outputs: --ham--</span>
sandwich = bread(ingredients(sandwich))
sandwich()
<span class="hljs-comment">#outputs:</span>
<span class="hljs-comment">#&lt;/''''''\&gt;</span>
<span class="hljs-comment"># #tomatoes#</span>
<span class="hljs-comment"># --ham--</span>
<span class="hljs-comment"># ~salad~</span>
<span class="hljs-comment">#&lt;\______/&gt;</span>
</code></pre>
<p>用Python装饰器语法糖:</p>
<pre><code class="lang-python"><span class="hljs-decorator">@bread</span>
<span class="hljs-decorator">@ingredients</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sandwich</span><span class="hljs-params">(food=<span class="hljs-string">"--ham--"</span>)</span>:</span>
    <span class="hljs-keyword">print</span> food

sandwich()
<span class="hljs-comment">#outputs:</span>
<span class="hljs-comment">#&lt;/''''''\&gt;</span>
<span class="hljs-comment"># #tomatoes#</span>
<span class="hljs-comment"># --ham--</span>
<span class="hljs-comment"># ~salad~</span>
<span class="hljs-comment">#&lt;\______/&gt;</span>
</code></pre>
<p>改变一下顺序:</p>
<pre><code class="lang-python"><span class="hljs-decorator">@ingredients</span>
<span class="hljs-decorator">@bread</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">strange_sandwich</span><span class="hljs-params">(food=<span class="hljs-string">"--ham--"</span>)</span>:</span>
    <span class="hljs-keyword">print</span> food

strange_sandwich()
<span class="hljs-comment">#outputs:</span>
<span class="hljs-comment">##tomatoes#</span>
<span class="hljs-comment">#&lt;/''''''\&gt;</span>
<span class="hljs-comment"># --ham--</span>
<span class="hljs-comment">#&lt;\______/&gt;</span>
<span class="hljs-comment"># ~salad~</span>
</code></pre>
<h4 id="">现在:回答你的问题...</h4>
<p>作为结论,相信你现在已经知道答案了:</p>
<pre><code class="lang-python"><span class="hljs-comment"># 字体变粗装饰器</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makebold</span><span class="hljs-params">(fn)</span>:</span>
    <span class="hljs-comment"># 装饰器将返回新的函数</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-comment"># 在之前或者之后插入新的代码</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;b&gt;"</span> + fn() + <span class="hljs-string">"&lt;/b&gt;"</span>
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># 斜体装饰器</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">makeitalic</span><span class="hljs-params">(fn)</span>:</span>
    <span class="hljs-comment"># 装饰器将返回新的函数</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-comment"># 在之前或者之后插入新的代码</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;i&gt;"</span> + fn() + <span class="hljs-string">"&lt;/i&gt;"</span>
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-decorator">@makebold</span>
<span class="hljs-decorator">@makeitalic</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>

<span class="hljs-keyword">print</span> say()
<span class="hljs-comment">#输出: &lt;b&gt;&lt;i&gt;hello&lt;/i&gt;&lt;/b&gt;</span>

<span class="hljs-comment"># 这相当于</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">say</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>
say = makebold(makeitalic(say))

<span class="hljs-keyword">print</span> say()
<span class="hljs-comment">#输出: &lt;b&gt;&lt;i&gt;hello&lt;/i&gt;&lt;/b&gt;</span>
</code></pre>
<p>别轻松太早,看看下面的高级用法</p>
<h3 id="">装饰器高级用法</h3>
<h4 id="">在装饰器函数里传入参数</h4>
<pre><code class="lang-python"><span class="hljs-comment"># 这不是什么黑魔法,你只需要让包装器传递参数:</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a_decorator_passing_arguments</span><span class="hljs-params">(function_to_decorate)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a_wrapper_accepting_arguments</span><span class="hljs-params">(arg1, arg2)</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"I got args! Look:"</span>, arg1, arg2
        function_to_decorate(arg1, arg2)
    <span class="hljs-keyword">return</span> a_wrapper_accepting_arguments

<span class="hljs-comment"># 当你调用装饰器返回的函数时,也就调用了包装器,把参数传入包装器里,</span>
<span class="hljs-comment"># 它将把参数传递给被装饰的函数里.</span>

<span class="hljs-decorator">@a_decorator_passing_arguments</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_full_name</span><span class="hljs-params">(first_name, last_name)</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"My name is"</span>, first_name, last_name

print_full_name(<span class="hljs-string">"Peter"</span>, <span class="hljs-string">"Venkman"</span>)
<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment">#I got args! Look: Peter Venkman</span>
<span class="hljs-comment">#My name is Peter Venkman</span>
</code></pre>
<h4 id="">装饰方法</h4>
<p>在Python里方法和函数几乎一样.唯一的区别就是方法的第一个参数是一个当前对象的(<code>self</code>)</p>
<p>也就是说你可以用同样的方式来装饰方法!只要记得把<code>self</code>加进去:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">method_friendly_decorator</span><span class="hljs-params">(method_to_decorate)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">(self, lie)</span>:</span>
        lie = lie - <span class="hljs-number">3</span> <span class="hljs-comment"># 女性福音 :-)</span>
        <span class="hljs-keyword">return</span> method_to_decorate(self, lie)
    <span class="hljs-keyword">return</span> wrapper


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lucy</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.age = <span class="hljs-number">32</span>

    <span class="hljs-decorator">@method_friendly_decorator</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayYourAge</span><span class="hljs-params">(self, lie)</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"I am %s, what did you think?"</span> % (self.age + lie)

l = Lucy()
l.sayYourAge(-<span class="hljs-number">3</span>)
<span class="hljs-comment">#输出: I am 26, what did you think?</span>
</code></pre>
<p>如果你想造一个更通用的可以同时满足方法和函数的装饰器,用<code>*args,**kwargs</code>就可以了</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a_decorator_passing_arbitrary_arguments</span><span class="hljs-params">(function_to_decorate)</span>:</span>
    <span class="hljs-comment"># 包装器接受所有参数</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a_wrapper_accepting_arbitrary_arguments</span><span class="hljs-params">(*args, **kwargs)</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Do I have args?:"</span>
        <span class="hljs-keyword">print</span> args
        <span class="hljs-keyword">print</span> kwargs
        <span class="hljs-comment"># 现在把*args,**kwargs解包</span>
        <span class="hljs-comment"># 如果你不明白什么是解包的话,请查阅:</span>
        <span class="hljs-comment"># http://www.saltycrane.com/blog/2008/01/how-to-use-args-and-kwargs-in-python/</span>
        function_to_decorate(*args, **kwargs)
    <span class="hljs-keyword">return</span> a_wrapper_accepting_arbitrary_arguments

<span class="hljs-decorator">@a_decorator_passing_arbitrary_arguments</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">function_with_no_argument</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Python is cool, no argument here."</span>

function_with_no_argument()
<span class="hljs-comment">#输出</span>
<span class="hljs-comment">#Do I have args?:</span>
<span class="hljs-comment">#()</span>
<span class="hljs-comment">#{}</span>
<span class="hljs-comment">#Python is cool, no argument here.</span>

<span class="hljs-decorator">@a_decorator_passing_arbitrary_arguments</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">function_with_arguments</span><span class="hljs-params">(a, b, c)</span>:</span>
    <span class="hljs-keyword">print</span> a, b, c

function_with_arguments(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)
<span class="hljs-comment">#输出</span>
<span class="hljs-comment">#Do I have args?:</span>
<span class="hljs-comment">#(1, 2, 3)</span>
<span class="hljs-comment">#{}</span>
<span class="hljs-comment">#1 2 3</span>

<span class="hljs-decorator">@a_decorator_passing_arbitrary_arguments</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">function_with_named_arguments</span><span class="hljs-params">(a, b, c, platypus=<span class="hljs-string">"Why not ?"</span>)</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Do %s, %s and %s like platypus? %s"</span> %\
    (a, b, c, platypus)

function_with_named_arguments(<span class="hljs-string">"Bill"</span>, <span class="hljs-string">"Linus"</span>, <span class="hljs-string">"Steve"</span>, platypus=<span class="hljs-string">"Indeed!"</span>)
<span class="hljs-comment">#输出</span>
<span class="hljs-comment">#Do I have args ? :</span>
<span class="hljs-comment">#('Bill', 'Linus', 'Steve')</span>
<span class="hljs-comment">#{'platypus': 'Indeed!'}</span>
<span class="hljs-comment">#Do Bill, Linus and Steve like platypus? Indeed!</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mary</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.age = <span class="hljs-number">31</span>

    <span class="hljs-decorator">@a_decorator_passing_arbitrary_arguments</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sayYourAge</span><span class="hljs-params">(self, lie=-<span class="hljs-number">3</span>)</span>:</span> <span class="hljs-comment"># 可以加入一个默认值</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"I am %s, what did you think ?"</span> % (self.age + lie)

m = Mary()
m.sayYourAge()
<span class="hljs-comment">#输出</span>
<span class="hljs-comment"># Do I have args?:</span>
<span class="hljs-comment">#(&lt;__main__.Mary object at 0xb7d303ac&gt;,)</span>
<span class="hljs-comment">#{}</span>
<span class="hljs-comment">#I am 28, what did you think?</span>
</code></pre>
<h3 id="">把参数传递给装饰器</h3>
<p>好了,如何把参数传递给装饰器自己?</p>
<p>因为装饰器必须接收一个函数当做参数,所以有点麻烦.好吧,你不可以直接把被装饰函数的参数传递给装饰器.</p>
<p>在我们考虑这个问题时,让我们重新回顾下:</p>
<pre><code class="lang-python"><span class="hljs-comment"># 装饰器就是一个'平常不过'的函数</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_decorator</span><span class="hljs-params">(func)</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I am an ordinary function"</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span><span class="hljs-params">()</span>:</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"I am function returned by the decorator"</span>
        func()
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># 因此你可以不用"@"也可以调用他</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lazy_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"zzzzzzzz"</span>

decorated_function = my_decorator(lazy_function)
<span class="hljs-comment">#输出: I am an ordinary function</span>

<span class="hljs-comment"># 之所以输出 "I am an ordinary function"是因为你调用了函数,</span>
<span class="hljs-comment"># 并非什么魔法.</span>

<span class="hljs-decorator">@my_decorator</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lazy_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"zzzzzzzz"</span>

<span class="hljs-comment">#输出: I am an ordinary function</span>
</code></pre>
<p>看见了吗,和&quot;<code>my_decorator</code>&quot;一样只是被调用.所以当你用<code>@my_decorator</code>你只是告诉Python去掉用被变量<code>my_decorator</code>标记的函数.</p>
<p>这非常重要!你的标记能直接指向装饰器.</p>
<p>让我们做点邪恶的事.☺</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorator_maker</span><span class="hljs-params">()</span>:</span>

    <span class="hljs-keyword">print</span> <span class="hljs-string">"I make decorators! I am executed only once: "</span>+\
          <span class="hljs-string">"when you make me create a decorator."</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_decorator</span><span class="hljs-params">(func)</span>:</span>

        <span class="hljs-keyword">print</span> <span class="hljs-string">"I am a decorator! I am executed only when you decorate a function."</span>

        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped</span><span class="hljs-params">()</span>:</span>
            <span class="hljs-keyword">print</span> (<span class="hljs-string">"I am the wrapper around the decorated function. "</span>
                  <span class="hljs-string">"I am called when you call the decorated function. "</span>
                  <span class="hljs-string">"As the wrapper, I return the RESULT of the decorated function."</span>)
            <span class="hljs-keyword">return</span> func()

        <span class="hljs-keyword">print</span> <span class="hljs-string">"As the decorator, I return the wrapped function."</span>

        <span class="hljs-keyword">return</span> wrapped

    <span class="hljs-keyword">print</span> <span class="hljs-string">"As a decorator maker, I return a decorator"</span>
    <span class="hljs-keyword">return</span> my_decorator

<span class="hljs-comment"># 让我们建一个装饰器.它只是一个新函数.</span>
new_decorator = decorator_maker()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="hljs-comment">#As a decorator maker, I return a decorator</span>

<span class="hljs-comment"># 下面来装饰一个函数</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorated_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I am the decorated function."</span>

decorated_function = new_decorator(decorated_function)
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="hljs-comment">#As the decorator, I return the wrapped function</span>

<span class="hljs-comment"># Let’s call the function:</span>
decorated_function()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="hljs-comment">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="hljs-comment">#I am the decorated function.</span>
</code></pre>
<p>一点都不难把.</p>
<p>下面让我们去掉所有可恶的中间变量:</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorated_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I am the decorated function."</span>
decorated_function = decorator_maker()(decorated_function)
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="hljs-comment">#As a decorator maker, I return a decorator</span>
<span class="hljs-comment">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="hljs-comment">#As the decorator, I return the wrapped function.</span>

<span class="hljs-comment"># 最后:</span>
decorated_function()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="hljs-comment">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="hljs-comment">#I am the decorated function.</span>
</code></pre>
<p>让我们简化一下:</p>
<pre><code class="lang-python"><span class="hljs-decorator">@decorator_maker()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorated_function</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"I am the decorated function."</span>
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="hljs-comment">#As a decorator maker, I return a decorator</span>
<span class="hljs-comment">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="hljs-comment">#As the decorator, I return the wrapped function.</span>

<span class="hljs-comment">#最终:</span>
decorated_function()
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="hljs-comment">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="hljs-comment">#I am the decorated function.</span>
</code></pre>
<p>看到了吗?我们用一个函数调用&quot;<code>@</code>&quot;语法!:-)</p>
<p>所以让我们回到装饰器的.如果我们在函数运行过程中动态生成装饰器,我们是不是可以把参数传递给函数?</p>
<pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorator_maker_with_arguments</span><span class="hljs-params">(decorator_arg1, decorator_arg2)</span>:</span>

    <span class="hljs-keyword">print</span> <span class="hljs-string">"I make decorators! And I accept arguments:"</span>, decorator_arg1, decorator_arg2

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">my_decorator</span><span class="hljs-params">(func)</span>:</span>
        <span class="hljs-comment"># 这里传递参数的能力是借鉴了 closures.</span>
        <span class="hljs-comment"># 如果对closures感到困惑可以看看下面这个:</span>
        <span class="hljs-comment"># http://stackoverflow.com/questions/13857/can-you-explain-closures-as-they-relate-to-python</span>
        <span class="hljs-keyword">print</span> <span class="hljs-string">"I am the decorator. Somehow you passed me arguments:"</span>, decorator_arg1, decorator_arg2

        <span class="hljs-comment"># 不要忘了装饰器参数和函数参数!</span>
        <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapped</span><span class="hljs-params">(function_arg1, function_arg2)</span> :</span>
            <span class="hljs-keyword">print</span> (<span class="hljs-string">"I am the wrapper around the decorated function.\n"</span>
                  <span class="hljs-string">"I can access all the variables\n"</span>
                  <span class="hljs-string">"\t- from the decorator: {0} {1}\n"</span>
                  <span class="hljs-string">"\t- from the function call: {2} {3}\n"</span>
                  <span class="hljs-string">"Then I can pass them to the decorated function"</span>
                  .format(decorator_arg1, decorator_arg2,
                          function_arg1, function_arg2))
            <span class="hljs-keyword">return</span> func(function_arg1, function_arg2)

        <span class="hljs-keyword">return</span> wrapped

    <span class="hljs-keyword">return</span> my_decorator

<span class="hljs-decorator">@decorator_maker_with_arguments("Leonard", "Sheldon")</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorated_function_with_arguments</span><span class="hljs-params">(function_arg1, function_arg2)</span>:</span>
    <span class="hljs-keyword">print</span> (<span class="hljs-string">"I am the decorated function and only knows about my arguments: {0}"</span>
           <span class="hljs-string">" {1}"</span>.format(function_arg1, function_arg2))

decorated_function_with_arguments(<span class="hljs-string">"Rajesh"</span>, <span class="hljs-string">"Howard"</span>)
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I make decorators! And I accept arguments: Leonard Sheldon</span>
<span class="hljs-comment">#I am the decorator. Somehow you passed me arguments: Leonard Sheldon</span>
<span class="hljs-comment">#I am the wrapper around the decorated function.</span>
<span class="hljs-comment">#I can access all the variables</span>
<span class="hljs-comment">#   - from the decorator: Leonard Sheldon</span>
<span class="hljs-comment">#   - from the function call: Rajesh Howard</span>
<span class="hljs-comment">#Then I can pass them to the decorated function</span>
<span class="hljs-comment">#I am the decorated function and only knows about my arguments: Rajesh Howard</span>
</code></pre>
<p>好了,上面就是带参数的装饰器.参数可以设置成变量:</p>
<pre><code class="lang-python">c1 = <span class="hljs-string">"Penny"</span>
c2 = <span class="hljs-string">"Leslie"</span>

<span class="hljs-decorator">@decorator_maker_with_arguments("Leonard", c1)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decorated_function_with_arguments</span><span class="hljs-params">(function_arg1, function_arg2)</span>:</span>
    <span class="hljs-keyword">print</span> (<span class="hljs-string">"I am the decorated function and only knows about my arguments:"</span>
           <span class="hljs-string">" {0} {1}"</span>.format(function_arg1, function_arg2))

decorated_function_with_arguments(c2, <span class="hljs-string">"Howard"</span>)
<span class="hljs-comment">#输出:</span>
<span class="hljs-comment">#I make decorators! And I accept arguments: Leonard Penny</span>
<span class="hljs-comment">#I am the decorator. Somehow you passed me arguments: Leonard Penny</span>
<span class="hljs-comment">#I am the wrapper around the decorated function.</span>
<span class="hljs-comment">#I can access all the variables</span>
<span class="hljs-comment">#   - from the decorator: Leonard Penny</span>
<span class="hljs-comment">#   - from the function call: Leslie Howard</span>
<span class="hljs-comment">#Then I can pass them to the decorated function</span>
<span class="hljs-comment">#I am the decorated function and only knows about my arguments: Leslie Howard</span>
</code></pre>
<p>你可以用这个小技巧把任何函数的参数传递给装饰器.如果你愿意还可以用<code>*args,**kwargs</code>.但是一定要记住了<strong>装饰器只能被调用一次</strong>.当Python载入脚本后,你不可以动态的设置参数了.当你运行<code>import x</code>,函数已经被装饰,所以你什么都不能动了.</p>
<h4 id="">来练习一下:装饰装饰器</h4>
<p>好吧,作为奖励,我就给你讲讲如何怎么让所有的装饰器接收任何参数.为了接收参数,我们用另外的函数来建我们的装饰器.</p>
<p>我们包装装饰器.</p>
<p>还有什么我们可以看到吗?</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../123/README.html" class="navigation navigation-prev " aria-label="Previous page: Python中的元类(metaclass)是什么?"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../12/README.html" class="navigation navigation-next " aria-label="Next page: 用Python如何检测一个文件是否存在?"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
